# chapter 04 Text and Byte(1)

Created: Mar 8, 2021 9:07 PM

파이썬3 부터는 인간이 사용하는 텍스트 문자열과 원시 바이트 시퀀스를 엄격히 구분하기 시작했다. 암묵적으로 바이트 시퀀스를 유니코드 문자열, 이진 시퀀스, 그리고 이 둘간의 변환에 사용되는 인코딩에 대해 설명한다. 

이 장에서는 다음 주제를 다룬다. 

- 문자, 코드 포인트, 바이트 표현
- 이진 시퀀스의 고유한 특징: bytes, bytearray, memoryview
- 전체 유니코드 및 레거시 문자셋에 대한 코덱
- 인코딩 에러를 피하고 다루기
- 텍스트 파일을 다룰때의 모범사례
- 기본 인코딩 및 표준 입출력 문제
- 정규화를 이용한 안전한 유니코드 텍스트 비교
- 정규화, 케이스 폴딩, 발음 구별 기호 강제제거를 위한 유틸리티 함수
- locale과 PyUCA 라이브러리를 이용한 유니코드 텍스트의 적절한 정렬
- 유니코드 데이터베이스안의 문자 메타 데이터
- str과 bytes 다루는 이중모드 API

### 4.1 문자 문제

현재 문자를 가장 잘 정의한 것은 유니코드 문자이다. 이에 따라서 python3 str에서 가져오는 항목도 유니코드 문자다. 유니코드 표준은 문자의 단위 원소와 특정 바이트 표현을 명확히 구분한다.

문자의 단위원소 (code point)는 10진수에 0~1,114,111까지의 숫자이며, 유니코드 표준에서 'U+' 접두사를 붙여 4자리에서 6자리 사이의 16진수로 표현한다. ex) 'A' = U+0041

문자를 표현하는 실제 바이트는 사용하는 인코딩에 따라 다르다. 인코딩은 코드포인트를 바이트 시퀀스로 변환하는 알고리즘이다. ex) 문자 'A' (U+0041)에 대한 코드 포인트는 UTF-8 인코딩에서는 1byte \x41로 변환한다.

코드포인트를 바이트로 변환하는 것을 인코딩, 바이트를 코드 포인트로 변환하는 것을 디코딩이라고 한다. (bytes 시퀀스를 사람이 읽을 수 있는 텍스트로 디코딩하고, str을 저장하거나 전송하기 위해 bytes로 인코딩한다.)

### 4.2 바이트에 대한 기본 지식

이진 시퀀스를 위해 사용되는 내장 자료형은 bytes와 bytearray, 두가지 있다. bytes 형은 파이썬3에서 소개된 immutable, bytearray는 파이썬2.6에서 추가된 mutable. (python2.6에서 bytes는 str의 별명이었다. 지금과 동작방식 또한 달랐다.)

bytes와 bytearray에 들어있는 각 항목은 0에서 255가지의 정수이다. 이진 시퀀스를 슬라이싱하면 언제나 동일한 자료형의 이진 시퀀스가 만들어진다. 

```python
cafe = bytes('café',encoding='utf_8')
cafe #b'caf\xc3\xa9'
cafe[0] #99
cafe[:1] # b'c'
```

s[0] == s[:1]이 되는 시퀀스형은 str이 유일하다. 그외의 모든 시퀀스형의 경우, s[i]는 항목하나를, s[ i : i+1]은 안에 s[i] 항목을 가진 동일한 자료형의 시퀀스를 반환한다. 

이진 시퀀스가 실제로 정수형의 시퀀스이기는 하지만, 리터럴 표기법을 보면 실제로는 아스키 텍스트가 들어가는 경우가 많다. 따라서 각 바이트 값에 따라 다음과 같이 세가지 형태로 출력된다.

- 화면에 출력 가능한 아스키 문자는 그대로 출력.
- whitespace 문자는 그대로 출력.
- 그외의 값은 16진수 이스케이프 시퀀스로 출력한다.

그렇기 때문에 예제에서 'café'를 표현할 떄, b'caf\xc3\xa9'에서 b'caf는 출력 가능한 아스키 범위에 있지만, 마지막 2바이트는 범웨 속하지 않는다. 

bytes와 bytearray는 포매팅하는 메서드를 제외하고 str이 제공하는 메서드 모두 지원한다. str 대신 이진 시퀀스로 정규 표현식을 컴파일하면, re 모듈에서 제공하는 정규 표현식 함수를 이진 시쿼스에도 적용할 수 있다. fromhex()라는 메서드를 사용하면 16진수 쌍을 이진 시퀀스로 만들 수 있다. 

bytes, bytearray, memoryview, array.array 등 버퍼 프로토콜을 구현한느 객체. 이 메서드를 사용하면 원본 객체의 바이트를 복사해서 바이트 시퀀스를 새로 생성한다. 버퍼 등의 객체로부터 이진 시퀀스를 생성하는 방법은 저 수준 연산으로서, 형변환이 필요할 수 있다. 

```python
import array
numbers = array.array('h',[-2,-1,0,1,2])
octets = bytes(numbers)
octets # b'\xfe\xff\xff\xff\x00\x00\x01\x00\x02\x00'
```

버퍼와 같은 객체로부터 bytes or bytearray 객체를 생성하면 언제나 바이트를 복사한다. 이와 반대로 memoryview는 이진 데이터 구조체 간에 메모리를 공유할수 있게 한다. 이진 시퀀스에서 구조화된 정보를 추출하려면 struct 모듈을 사용한다. 

### 4.2.1 구조체와 메모리 뷰

struct 모듈은 패킹된 바이트를 다양한 형의 필드로 구성된 튜플로 분석하고, 이와 반대로 튜플을 패킹된 바이트로 변환하는 함수를 제공한다. 

메모리뷰 클래스로 바이트 시퀀스를 생성하거나, 저장할 수는 없지만 바이트를 복사하지 않고 다른 이진 시퀀스, 패킹된 배열, 혹은 파이썬 이미징 라이브러리 (PIL) 이미지 등의 버퍼 데이터의 슬라이스에 공유 메모리 방식으로 접근할 수 있게한다. ( mmap 모듈을 사용해서 이미지를 맵 파일로 열면 훨씬 더 적은 바이트가 복사된다.) 

### 4.3 기본 인코더/디코더

텍스트를 바이트로 혹은 바이트를 텍스트로 변환하기 위해 파이썬 배포본에는 100여 개의 코덱(인코더/디코더)이 포함되어 있다. 예시로는 utf_8,utf-8, U8 등으로 불리기도 한다. open(), str.encode(), bytes.decode() 등의 함수를 호출할 때 encoding 인수에 사용할 수 있따. 

- latin1(iso8859_1) : cp1252와 같은 다른 인코딩 방식 및 유니코드 자체의 기반이 되는 중요한 인코딩 방식이다.
- utf-8 : 웹에서 8비트 인코딩을 하기위해 가장 널리 사용되는 인코딩 방식으로, 아스키 코드와 하위호환된다. (순수 아스키 텍스트는 정당한 UTF-8 code 이다.)

###